<!DOCTYPE html>
<html lang="en">

<head>
    <!-- Swiper CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@10/swiper-bundle.min.css" />

    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Custom Odds</title>

    <style>
        /* Dropdown container */
        .dropdown {
            position: relative;
            width: 100%;
            cursor: pointer;
            z-index: 100;
        }

        /* Selected button */
        .dropdown .selected {
            padding: 8px 12px;
            border: 1px solid #ffc107;
            border-radius: 6px;
            background: #0a1f44;
            color: #ffd700;
            font-weight: 500;
            text-align: left;
        }

        /* Options container as bottom modal */
        .dropdown .options {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 200px;
            overflow-y: auto;
            background: #0a1f44;
            border-top-left-radius: 12px;
            border-top-right-radius: 12px;
            box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.6);
            z-index: 1000;
            padding: 0;
        }

        /* Hide scrollbars */
        .dropdown .options::-webkit-scrollbar {
            display: none;
        }

        .dropdown .options {
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        /* Header with close button */
        .dropdown .options-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: #1f2e4a;
            border-top-left-radius: 12px;
            border-top-right-radius: 12px;
            color: #ffd700;
            font-weight: bold;
        }

        /* Close button */
        .dropdown .options-header .close-btn {
            cursor: pointer;
            font-size: 1.2rem;
        }

        /* Option styling */
        .dropdown .option {
            padding: 12px 16px;
            border-bottom: 1px solid rgba(255, 215, 0, 0.2);
            color: #ffd700;
            font-weight: 400;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .dropdown .option:last-child {
            border-bottom: none;
        }

        /* Hover effect */
        .dropdown .option:hover {
            background-color: rgba(255, 215, 0, 0.1);
            color: #ffc107;
        }

        /* Open state */
        .dropdown.open .options {
            display: block;
        }

        /* Prevent body scroll while modal open */
        body.no-scroll {
            overflow: hidden;
        }
        

        .selectDate {
            background: transparent;
            color: #ffd700;
            border: none;
            border-bottom: 2px solid #ffc107;
            outline: none;
            padding: 4px 2px;
            font-size: 0.9rem;
            font-weight: 500;
            text-align: right;
            cursor: pointer;
            transition: border-color 0.3s ease, color 0.3s ease;
            width: 120px; /* adjust to fit nicely beside label */
            }

            /* Change underline color on hover/focus */
            .selectDate:hover,
            .selectDate:focus {
            border-bottom-color: #ffeb3b;
            color: #fff;
            }

            /* Hide the native calendar icon (Chrome, Edge, etc.) */
            .selectDate::-webkit-calendar-picker-indicator {
            filter: invert(75%) sepia(80%) saturate(600%) hue-rotate(5deg);
            opacity: 0.7;
            cursor: pointer;
            transition: opacity 0.3s ease;
            }

            .selectDate:hover::-webkit-calendar-picker-indicator {
            opacity: 1;
            }

            /* Firefox fix - makes text visible */
            @-moz-document url-prefix() {
            .selectDate {
                color-scheme: dark;
            }
        }

    </style>

    <!-- CSS -->
    <link rel="stylesheet" href="./styles/generate.css" />
    <link rel="stylesheet" href="./styles/his.css" />
    <link rel="stylesheet" href="./styles/response.css" />
    <link rel="stylesheet" href="./styles/slide.css" />
    <link rel="stylesheet" href="./styles/sug.css" />
    <link rel="stylesheet" href="./styles/themes.css" />
</head>

<body>
    <div class="wrap">
        <header>
            <h1>
                <a href="./" style="color: #fff; text-decoration: none;">&lt; Back</a>
            </h1>
            <div class="spinner" id="spinner">
                <div class="dot"></div>
                <div class="dot"></div>
                <div class="dot"></div>
                Generating…
            </div>
        </header>

        <section class="card">
            <div class="controls">
                <div class="field sport">
                    <label for="sport" style="display: flex; justify-content: space-between;">
                        Sport
                        <div class="date" style="font-weight: normal; font-size: 0.9rem;">
                            <input class="selectDate" type="date" id="startDate" required />
                        </div>
                    </label>
                    <select id="sport">
                        <!-- options will be dynamically inserted -->
                    </select>
                </div>
                
                

                <div class="field target">
                    <label for="oddsTarget">Target Odds <b id="oddsTargetLabel" style="opacity: 0;">500.00</b></label>
                    <div class="slider-row">
                        <input id="oddsTarget" type="range" min="2" max="1000" value="10" step="1" />
                        <input id="oddsTargetNumber" type="number" min="2" max="1000" value="10" />
                    </div>
                </div>

                <div class="field risk">
                    <label>Risk Level</label>
                    <div class="pill-group" id="riskGroup"></div>
                </div>

                <div class="field go">
                    <button class="btn btn-primary" id="generateBtn">GO</button>
                </div>
            </div>

            <div class="meta">
                <div class="stat">Selected Matches: <b id="selectedCount">0</b></div>
                <div class="stat">Total Odds: <b id="totalOdds">0</b></div>
                <div class="stat">Target: <b id="targetEcho">0</b></div>
                <div class="stat">Tolerance: <b id="toleranceEcho">±10%</b></div>
                <div class="stat">Risk: <b id="riskEcho">Low</b></div>
            </div>

            <!-- Loading placeholder -->
            <div id="loadingPlaceholder"
                style="text-align:center;padding:40px;color:#ffc107;display:block;opacity:1;transition: opacity 0.6s ease;">
                <div
                    style="border:4px solid rgba(255,193,7,0.2);border-top:4px solid #ffc107;border-radius:50%;width:40px;height:40px;margin:0 auto 10px auto;animation: spin 1s linear infinite;">
                </div>
                <span>Loading matches...</span>
            </div>

            <!-- Auto/User-selected matches -->
            <div id="selectedSection" style="display:none; opacity:0; transition:opacity 0.6s ease;">
                <h3 id="selectedHeader">Selected Matches</h3>
                <div id="selectedList">⚽ Match 1</div>
            </div>

            <!-- Remaining matches -->
            <div id="unselectedSection" style="display:none; opacity:0; transition:opacity 0.6s ease;">
                <h3 id="unselectedHeader">Other Matches</h3>
                <div id="unselectedList">⚽ Match 2</div>
            </div>

            <!-- Scroll-to-top button -->
            <div id="scrollTopBtn"
                style="position:fixed; bottom:100px; right:20px;width:50px; height:50px; border-radius:50%; background:#ffc107; display:flex; align-items:center; justify-content:center; box-shadow:0 4px 10px rgba(0,0,0,0.25); cursor:pointer; transition:opacity 0.3s, transform 0.3s; font-size:28px; font-weight:bold; color:#000; z-index:9999; opacity:0; visibility:hidden;">
                ↑</div>
        </section>

        <div class="footer">
            <div class="totals">
                <div>
                    <div class="big" id="totalOddsBig">0.00</div>
                    <div class="hint">Select matches to move closer to your target.</div>
                </div>
                <div class="actions">
                    <button class="btn btn-ghost" id="regenerateBtn">Regenerate</button>
                    <button class="btn" id="resetBtn">Reset</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Custom Alert Box -->
    <div id="custom-alert" class="custom-alert hidden">
        <div class="custom-alert-content">
            <div id="alert-icon" class="alert-icon"></div>
            <h3 id="alert-title"></h3>
            <p id="alert-message"></p>
            <button id="alert-ok-btn">OK</button>
        </div>
    </div>

    <script src="./scripts/generate.js"></script>
    <!-- Swiper JS -->
    <script src="https://cdn.jsdelivr.net/npm/swiper@10/swiper-bundle.min.js"></script>

    <script>
        const scrollBtn = document.getElementById("scrollTopBtn");
        window.addEventListener("scroll", () => {
            const scrollY = window.scrollY || document.documentElement.scrollTop;
            const pageHeight = document.documentElement.scrollHeight;
            const clientHeight = document.documentElement.clientHeight;
            if (scrollY > 100 && pageHeight > clientHeight + 150) {
                scrollBtn.style.opacity = "1";
                scrollBtn.style.visibility = "visible";
            } else {
                scrollBtn.style.opacity = "0";
                scrollBtn.style.visibility = "hidden";
            }
        });
        scrollBtn.addEventListener("click", () => {
            window.scrollTo({ top: 0, behavior: "smooth" });
        });

        const style = document.createElement("style");
        style.innerHTML = `
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }`;
        document.head.appendChild(style);

        function showLoading() {
            const loader = document.getElementById("loadingPlaceholder");
            loader.style.display = "block";
            loader.style.opacity = "1";
            document.getElementById("selectedSection").style.display = "none";
            document.getElementById("unselectedSection").style.display = "none";
        }

        function hideLoading() {
            const loader = document.getElementById("loadingPlaceholder");
            loader.style.opacity = "0";
            setTimeout(() => {
                loader.style.display = "none";
                const selected = document.getElementById("selectedSection");
                const unselected = document.getElementById("unselectedSection");
                selected.style.display = "block";
                unselected.style.display = "block";
                setTimeout(() => {
                    selected.style.opacity = "1";
                    unselected.style.opacity = "1";
                }, 50);
            }, 600);
        }

        showLoading();
        setTimeout(() => {
            hideLoading();
        }, 2000);

        // === Fetch & Process Matches ===
        const today = new Date();
        const yyyy = today.getFullYear();
        const mm = String(today.getMonth() + 1).padStart(2, "0");
        const dd = String(today.getDate()).padStart(2, "0");
        const todayYYYYMMDD = `${yyyy}-${mm}-${dd}`;

        async function fetchMatchesFromAPI(selectedDate) {
            try {
                showLoading();
                const res = await fetch(`./backend/t.php?date=${selectedDate}`);
                if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);

                const apiData = await res.json();
                console.log("Fetched Data:", apiData);
                processPredictions(apiData);
                loadApiMatches(apiData);
                localStorage.setItem("defaultPredictions", JSON.stringify(apiData));
                hideLoading();
            } catch (err) {
                showCustomAlert("Failed to load matches: " + err.message, "error");
            }
        }

        function processPredictions(matches) {
            if (!Array.isArray(matches)) return;
            const thresholds = { very_low: 0, low: 20, medium: 40, high: 60, very_high: 80 };
            let best = { very_low: null, low: null, medium: null, high: null, very_high: null };

            matches.forEach(match => {
                if (match.sport !== "Soccer") return;
                if (!Array.isArray(match.prediction)) return;
                match.prediction.forEach(pred => {
                    if (!pred.predictions) return;
                    const values = Object.values(pred.predictions).map(Number).filter(v => !isNaN(v));
                    if (values.length === 0) return;
                    const maxProb = Math.max(...values);
                    let category = null;
                    if (maxProb < thresholds.low) category = "very_low";
                    else if (maxProb < thresholds.medium) category = "low";
                    else if (maxProb < thresholds.high) category = "medium";
                    else if (maxProb < thresholds.very_high) category = "high";
                    else category = "very_high";

                    if (!best[category] || maxProb > best[category].confidence) {
                        const outcomeKey = Object.keys(pred.predictions).reduce((bestKey, key) =>
                            pred.predictions[key] > (pred.predictions[bestKey] || 0) ? key : bestKey, null);
                        best[category] = {
                            time: match.kick || match.time || "",
                            teams: `${match.home} vs ${match.away}`,
                            league: match.league || "",
                            homeLogo: match.homeLogo || "",
                            awayLogo: match.awayLogo || "",
                            home: match.home || "",
                            away: match.away || "",
                            odd: match.odds || "",
                            score: match.score || "0 - 0",
                            prediction: outcomeKey ? `${pred.market} - ${outcomeKey}` : pred.market,
                            confidence: maxProb,
                            isFavorited: false
                        };
                    }
                });
            });

            localStorage.setItem("bestPredictions", JSON.stringify(best));
            console.log("Saved Best Predictions:", best);
        }

        let selectedDate;
        const selectDate = document.getElementById("startDate");
        selectDate.addEventListener("change", (e) => {
            selectedDate = e.target.value;
            if (selectedDate) {
                fetchMatchesFromAPI(selectedDate);
            } else {
                fetchMatchesFromAPI(todayYYYYMMDD);
            }
        });

        selectDate.value = todayYYYYMMDD;
        fetchMatchesFromAPI(todayYYYYMMDD);

    </script>
</body>

</html>